@using Microsoft.AspNetCore.Http
@{
    var nombreUsuario = Context.Session.GetString("NombreUsuario");
}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>MathematicalRhythm 🎶</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome para íconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <style>
        /* Estilos personalizados adicionales */
        .music-gradient-bg {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        }

        .hover-scale {
            transition: transform 0.2s ease;
        }

            .hover-scale:hover {
                transform: scale(1.03);
            }
    </style>
</head>
<body class="music-gradient-bg text-gray-100 min-h-screen flex flex-col">
    <!-- Navbar -->
    <nav class="bg-gray-900 border-b border-purple-900 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Logo/Brand -->
                <div class="flex-shrink-0 flex items-center">
                    <a href="/VistaUsuario/Index" class="text-xl font-bold text-purple-400 hover:text-purple-300 flex items-center">
                        <span class="mr-2">MathematicalRhythm</span>
                        <span>🎵</span>
                    </a>
                </div>

                <!-- Mobile menu button -->
                <div class="md:hidden">
                    <button type="button" class="text-gray-300 hover:text-white focus:outline-none" id="mobile-menu-button">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                </div>

                <!-- Desktop Menu -->
                <div class="hidden md:block">
                    <div class="ml-10 flex items-center space-x-4">
                        <a href="/VistaUsuario/Buzon" class="text-gray-300 hover:bg-gray-800 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Buzón</a>
                        <a href="/VistaUsuario/Contacto" class="text-gray-300 hover:bg-gray-800 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Contáctanos</a>
                        <a href="/VistaUsuario/Ayuda" class="text-gray-300 hover:bg-gray-800 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Ayuda</a>

                        <!-- Chatbot Trigger -->
                        <button id="navbar-chatbot-trigger" class="text-gray-300 hover:bg-gray-800 hover:text-white px-3 py-2 rounded-md text-sm font-medium flex items-center">
                            <i class="fas fa-robot mr-2"></i>
                            <span>Asistente</span>
                        </button>

                        
                        <!-- Search Bar -->
                        <div class="relative flex">
                            <input type="search" id="realTimeSearch" placeholder="Buscar música..."
                                   class="px-3 py-1 bg-gray-700 text-white rounded-l-md text-sm focus:outline-none focus:ring-1 focus:ring-purple-500 w-40 sm:w-64"
                                   autocomplete="off" />
                            <button class="bg-purple-600 hover:bg-purple-700 px-3 py-1 rounded-r-md text-sm">
                                <i class="fas fa-search"></i>
                            </button>
                            <div id="searchResultsDropdown" class="absolute hidden top-full left-0 w-full mt-1 bg-gray-800 rounded-md shadow-lg z-50 max-h-80 overflow-y-auto"></div>
                        </div>

                        <!-- User Info -->
                        @if (!string.IsNullOrEmpty(nombreUsuario))
                        {
                            <span class="text-gray-300 text-sm font-medium">@nombreUsuario</span>
                        }
                        <a href="/Auth/Logout" class="text-red-400 hover:text-red-300 text-sm font-medium">Salir</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile Menu (hidden by default) -->
        <div class="md:hidden hidden" id="mobile-menu">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                <a href="/Home/Index" class="text-gray-300 hover:bg-gray-800 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Buzón</a>
                <a href="/VistaUsuario/Contacto" class="text-gray-300 hover:bg-gray-800 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Contáctanos</a>
                <a href="/Recuperar/Index" class="text-gray-300 hover:bg-gray-800 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Ayuda</a>
                <button id="mobile-chatbot-trigger" class="text-gray-300 hover:bg-gray-800 hover:text-white w-full text-left px-3 py-2 rounded-md text-base font-medium flex items-center">
                    <i class="fas fa-robot mr-2"></i>
                    <span>Asistente</span>
                </button>
            </div>
            <div class="pt-4 pb-3 border-t border-gray-700">
                @if (!string.IsNullOrEmpty(nombreUsuario))
                {
                    <div class="flex items-center px-5">
                        <div class="text-base font-medium text-white">@nombreUsuario</div>
                    </div>
                }
                <div class="mt-3 px-2 space-y-1">
                    <a href="/Auth/Logout" class="block px-3 py-2 rounded-md text-base font-medium text-red-400 hover:text-red-300 hover:bg-gray-800">Salir</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        @RenderBody()
    </main>

    <!-- Footer -->
    <footer class="bg-gray-900 border-t border-purple-900 py-4">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-sm text-gray-400">
            &copy; 2025 MathematicalRhythm. Todos los derechos reservados.
        </div>
    </footer>


    <script>
        //Busqueda
             document.addEventListener('DOMContentLoaded', function() {
            const API_BASE_URL = window.location.origin; // Usa la misma URL del sitio
            const searchInput = document.getElementById('realTimeSearch');
            const resultsDropdown = document.getElementById('searchResultsDropdown');
            let searchTimeout;

            function displayResults(data) {
                let html = '';

                if (data.Songs && data.Songs.length > 0) {
                    html += '<div class="search-result-category">Canciones</div>';
                    data.Songs.forEach(song => {
                        html += `
                            <div class="search-result-item" data-id="${song.Id}" data-type="song">
                                <strong>${song.Name}</strong>
                                <div class="text-xs text-gray-400">${song.Artist} • ${song.Duration}</div>
                            </div>`;
                    });
                }

                if (data.Artists && data.Artists.length > 0) {
                    html += '<div class="search-result-category">Artistas</div>';
                    data.Artists.forEach(artist => {
                        html += `
                            <div class="search-result-item" data-id="${artist.Id}" data-type="artist">
                                <strong>${artist.Name}</strong>
                                <div class="text-xs text-gray-400">${artist.Genre}</div>
                            </div>`;
                    });
                }

                if (data.Albums && data.Albums.length > 0) {
                    html += '<div class="search-result-category">Álbumes</div>';
                    data.Albums.forEach(album => {
                        html += `
                            <div class="search-result-item" data-id="${album.Id}" data-type="album">
                                <strong>${album.Name}</strong>
                                <div class="text-xs text-gray-400">${album.Artist} • ${album.Year}</div>
                            </div>`;
                    });
                }

                if (html === '') {
                    html = '<div class="search-result-item">No se encontraron resultados</div>';
                }

                resultsDropdown.innerHTML = html;
                resultsDropdown.classList.remove('hidden');
            }

            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const query = this.value.trim();

                if (query.length < 2) {
                    resultsDropdown.classList.add('hidden');
                    return;
                }

                searchTimeout = setTimeout(() => {
                    fetch(`${API_BASE_URL}/Search/Search?query=${encodeURIComponent(query)}`)
                        .then(response => {
                            if (!response.ok) throw new Error('Error en el servidor');
                            return response.json();
                        })
                        .then(data => {
                            if (data.success) {
                                displayResults(data.data);
                            } else {
                                throw new Error(data.message || 'Error en la búsqueda');
                            }
                        })
                        .catch(error => {
                            console.error('Search error:', error);
                            resultsDropdown.innerHTML = `
                                <div class="search-result-item text-red-400">
                                    ${error.message}
                                </div>`;
                            resultsDropdown.classList.remove('hidden');
                        });
                }, 300);
            });

            // Cerrar dropdown al hacer clic fuera
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.relative.flex')) {
                    resultsDropdown.classList.add('hidden');
                }
            });
        });







        //LOGIN
        // 1. Forzar recarga si viene de caché
        window.onpageshow = function(event) {
            if (event.persisted) {
                window.location.href = '@Url.Action("Login", "Auth")';
            }
        };

        // 2. Bloquear navegación "Atrás"
        history.pushState(null, null, document.URL);
        window.addEventListener('popstate', function() {
            history.pushState(null, null, document.URL);
            window.location.href = '@Url.Action("AccessDenied", "Error")'; // Opcional: Redirige a error
        });
    </script>
    <!-- Scripts -->
    <script>
        // Mobile menu toggle
        document.getElementById('mobile-menu-button').addEventListener('click', function() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        });

        // Chatbot toggle (desktop)
        document.getElementById('navbar-chatbot-trigger').addEventListener('click', function() {
            const chatbotBody = document.getElementById('chatbot-body');
            const chatbotToggle = document.getElementById('chatbot-toggle');

            if (chatbotBody.style.display === 'none') {
                chatbotBody.style.display = 'flex';
                chatbotToggle.textContent = '▲';
            } else {
                chatbotBody.style.display = 'none';
                chatbotToggle.textContent = '▼';
            }
        });

        // Chatbot toggle (mobile)
        document.getElementById('mobile-chatbot-trigger')?.addEventListener('click', function() {
            const chatbotBody = document.getElementById('chatbot-body');
            const chatbotToggle = document.getElementById('chatbot-toggle');

            if (chatbotBody.style.display === 'none') {
                chatbotBody.style.display = 'flex';
                chatbotToggle.textContent = '▲';
            } else {
                chatbotBody.style.display = 'none';
                chatbotToggle.textContent = '▼';
            }

            // Close mobile menu after selection
            document.getElementById('mobile-menu').classList.add('hidden');
        });
    </script>

    @await RenderSectionAsync("Scripts", required: false)
    @await Html.PartialAsync("_ChatbotPartial")
</body>
</html>